---
layout: post
title:  由一场面试想到的...
date: 2020-03-03
Author: Yanfei Tang
tags: [physics]
comments: false
---

&emsp;&emsp;最近，我非常有幸地收到一家知名软件公司的面试邀请，从几位面试官的介绍和提问中，我学习到了一些关于软件设计的知识。我并没有受到过计算机学科系统性的培养，这些知识对我来说非常新颖但又仿佛似曾相识。联想到我的博士经历，我反思假使有了这些知识，会让我之前的工作变得更富有成效。

<!-- more -->

## 一种凝聚态计算物理文章的范式？

&emsp;&emsp;我在经过弗吉尼亚理工物理系第一学年的学习之后，便加入了凝聚态物理理论组开始自己的第一个课题研究。虽然说是物理理论组，但实际的工作是使用计算机编程求解一些模型，并不是纸笔就能完成的推导式的工作。计算机编程对于理工科的学生来说并没那么“复杂”，毕竟大多数人在大学本科低年级时都已经学过一门编程语言了。然而事实上是，想要做好凝聚态理论的编程模拟工作，量子物理是一道门槛，这道门槛是显而易见的，而想让产出变得高效而又有质量，光有物理知识还不够，还需要把物理知识升华成物理的全局思维。再然后，若想让一系列的工作变成系统性的工作，对于计算物理来说，需要有现代的编程理念[^1]。

&emsp;&emsp;首先来聊聊量子物理这道门槛，因为想要模拟这个系统，首先要能理解我们需要模拟的**哈密顿量**。所谓哈密顿量，它在经典物理里面是描述一个系统状态的动量和势能总和（即能量）的物理量，在量子物理领域它是一个作用在体系状态的能量算符。求解物理体系的哈密顿量是许多物理学工作者毕生研究的问题，而我当时的课题就是去用计算机求解一个叫做玻色赫伯德模型的哈密顿量。

&emsp;&emsp;单单有一个哈密顿量对于模拟来说还是不够的，我们还需要一个**几何结构**。物理中非常神奇的地方是，不同的几何结构在同样的哈密顿量下，他们的物理特性往往是不一样的。有些几何结构在一些哈密顿量下可能表现出平凡的物理特性，但在同样的哈密顿量下，有些“奇怪的”几何结构可能表现出超凡的物理特性。不少物理学工作者在某段研究生涯期间会对一系列的几何结构在相同的哈密顿量下进行考察。对于刚刚处在研究初期的我来说，正方形的二维格子结构无疑是最合适的选择，因为它是最简单的一种二维几何结构。图1介绍了几种在物理中非常常见的二维几何结构。

<p align="center">
   <img src="/images/2020/thoughts-after-interview/lattice_structure.png" alt="drawing" style="width:800px;" align="middle"/>
   <em>图1. 在计算凝聚态物理中经常考察的几何结构：（a）正方形格子（b）蜂窝状格子（c）Kagome 格子（以色列🇮🇱国旗中央的图案）</em>
</p>

&emsp;&emsp;有了哈密顿量和几何结构，我们就有了一个物理体系。想要数值上求解这个物理体系，就需要一个**方法**，这里的方法可谓是五花八门千奇百怪，我在这里枚举几个常见于文献的方法，比如说，严格对角化，蒙特卡洛，密度矩阵重整化群等等。值得注意的是每种方法都有明显的缺陷，比如严格对角化只能求解非常小的体系，蒙特卡洛求解的体系比严格对角化来的大，但是它有符号问题[^2]，总之没有一个方法是一招通吃的，而采用哪种方法往往需要考察物理体系对这种缺陷的敏感程度。当时导师让给我采用的方法是蒙特卡洛中随机级数展开的方法，以此来研究二维正方形格子下的玻色赫伯德模型。

&emsp;&emsp;按照以上的理解，我想作为读者的您或许已经看出凝聚态计算物理中课题的范式了，我们可以把凝聚态计算物理拆分成如下，

$$
计算凝聚态物理 \simeq 哈密顿量+几何结构+方法, \\
哈密顿量 \in \{赫伯德模型，近藤模型，霍尔丹模型，汤川模型,\cdots  \}, \\
几何结构 \in \{正方形格子，蜂窝格子，三维正方体，棋盘结构,\cdots \} ,\\
方法 \in \{严格对角化，蒙特卡洛，密度矩阵重整化群, \cdots \},
$$

当然这样的归类显然把凝聚态计算物理的研究简单化了，但很好的把我的项目划进了这样的范式，

$$
我的项目 \simeq 玻色赫伯德模型+正方形格子+蒙特卡洛,
$$

而这个范式也适用于我同一组的研究生，他的项目是用严格对角化的方法研究棋盘结构的汤川模型。

$$
同组研究生的项目 \simeq 汤川模型+棋盘结构+严格对角化
$$

## 一个需求的变更

&emsp;&emsp;当我顺利地把我的程序编写完后，我做了一些基准测试。我比较了我的结果和文献上的结果，保证我的程序数据输出是符合物理预期的。我满心欢喜地告诉我的导师，我的代码写完了测试也做完了，他说道，“既然你现在已经掌握了这种方法，那么我们可以开始做一些别人都没有做过的事情了，正方形格子别人已经做过了，但是我们不妨尝试做双层的正方形格子，我敢肯定这个没有人做过。”

&emsp;&emsp;要想把正方形格子变成双层的，模型会多出一个参数，但它终究还是玻色赫伯德模型，然而几何结构的变换对于当时的我来说是致命的，我发现去修改代码还不如再写一遍来的痛快，顺便还能理清一下思路。因为已经熟悉方法了，这次我花了若干天的时间把双层的正方形格子的代码写完了，当然我发现之前很多代码模块是可以复用的。写完后，我有了两个程序，一个是模拟正方形格子的程序，另外一个是模拟双层正方形格子的程序。从我现在的角度来看，之前的代码一点扩展性都没有，但对于当时我所在的物理系的许多做计算的学生甚至是教授都不会在乎，（当时我也不在乎，我只是觉得这个做法有点丑陋）。我甚至记得有教授说，我们不是计算机系，我们不关心代码写的漂不漂亮，花不花哨（fancy），只要结果正确就行了。

&emsp;&emsp;这样的想法对于研究计算方法论的是没有问题的，在七八十年代也没有问题，但对于现代的计算物理学已经不再适用了，特别是对于大型的计算项目已经是落后了。对于进阶的计算物理工作者来说，已经不能仅仅满足于小型项目而需要关注代码的扩展性。要构造一个扩展性高的代码需要对物理有一个全局的考量，也少不了程序的设计模式。计算物理在七八十年代最主流的编程语言是Fortran[^3]，采用的思想是面向过程（分解问题）的思考方法。这样的思考方式对我当时的一些项目来说，当然是绰绰有余了。但随着项目的深入和新的要求，比如说像几何结构变更这样的要求，分解问题的思考方式虽然仍可胜任，但它的做法不够“漂亮”，特别是如果需要增加几十种不同的几何结构的情形下。而当时我的导师很热衷于这样的变换，因为作为物理学家需要广泛地考察哈密顿量在不同几何结构下的物理行为。

&emsp;&emsp;几何结构和模型哈密顿量的形式其实还是有一定的耦合，比如，从正方形格子到双层的正方形格子，模型的哈密顿量会增加一个参数。如果需要定义一个几何结构，那么就需要知道点和边。对于点，我需要知道粒子属性（是玻色子还是费米子），占据数，近邻点，序号，跃迁能量，化学势等。对于边，我需要知道边所连接的点，序号，跃迁能量等。从定义上来看，也能看到模型哈密顿量和几何结构的耦合，跃迁能量和化学势是从模型中定义的。但值得庆幸的是，几何结构对于我采用的蒙特卡洛的方法是脱耦的，所以我不需要担心换一个几何结构就需要修改方法里面的代码。无论几何结构怎么变换，蒙特卡洛部分的代码原则上是不需要变动的，可以高度的模块化。有了模型，几何结构和方法就形成了一套计算流程，如果再加上物理量的测量和数据的输出，把他们拼起来形成一个整体，那么就完成了一整套计算体系。

&emsp;&emsp;写了那么多，读者可能纳闷了，你的标题是面试后的思考，然而通篇都是物理学的泛泛之谈和你博士的经历，两者有什么关系呢？在我面试的过程中，两度被问及“如何看待打磨产品？”，我一时之间被问得丈二和尚摸不着头脑，面试过后我上网看了几集C++设计模式的视频，才开始了解到面向对象设计的美妙之处，太精彩了[^4]。我导师叫我更换几何结构就是一种用户需求的变更，而作为代码实现的我需要去抵御这样的需求变更。但惋惜的是，6年前的我还没有现在我对计算凝聚态物理的理解，不识庐山真面目。6年前的我也才开始第一次学习C++，其实我学的更像是C和vector这个标准库。故而，才会发生改一个几何结构，居然重新写了一遍程序这样的经历，令人羞愧的是这个情形还是代码量很少的情况下发生的。在完成这个变更几何结构的任务后，我把更多的精力集中到了物理本身而不是计算上来，毕竟正如当时大多数人说的“只要结果正确就行了”。但从现代计算物理学结合多人协作开发的角度来看，仅仅是结果正确或许还不够。添加新的功能（比如加入新的几何结构）如果还需要对原有的代码进行修改，那简直就是灾难。在一个好的设计模式下，后续的需求的增加在理想情况下是隔离于原有的代码的。打磨产品，或者说代码的重构，要把扩展代码的成本降低抵御未来的需求的变更。

&emsp;&emsp;高山仰止，景行行止。文章的最后，我把以前我的合作者Michael[^5]的一张幻灯片拿来勉励自己。

<p align="center">
   <img src="/images/2020/thoughts-after-interview/michael.png" alt="drawing" style="width:800px;" align="middle"/>
   <em>图2. DCA++从第一版到第二版过程中软件开发成本和功能的变化曲线图。</em>
</p>



[^1]: 我幸运地仰望过二件系统性的计算物理软件，其中一件是DCA++2.0，用来模拟高温超导体，由我曾经的一位导师Dr.Maier和十位计算物理学家合作完成。在2008年，团队凭借这项工作拿到了[ACM Gordon Bell Award](https://awards.acm.org/bell)，这个奖项是授予在高性能计算领域中的杰出工作。获奖成员每个人都是履历丰富，硕果累累，而其中有位成员比较特殊，Michael Summers，他是卡内基梅隆大学应用数学背景出身，40年的工作经历，资深的程序员和数学家，DCA++2.0程序编写的负责人。

[^2]: 关于符号问题，参看[知乎回答](https://www.zhihu.com/question/59398925)

[^3]: 这是很多年纪大的计算物理工作者的编程语言，也是我最早接触过的一门编程语言之一。

[^4]: 这种感觉有点像Dr. Minic讲场论的时候，从作用量推导出麦克斯韦方程。

[^5]: 虽然说Michael Summers是我的合作者，但他对我那篇文章的贡献只是提供给我一段数据而已。他是晚上6点来办公的，因此我和他接触其实也很少。






















